---
name: Set Branch Protections
on:
  push:
    branches:
      - "**"
  pull_request:
  workflow_dispatch:
jobs:
  set-branch-protections:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set Branch Protections
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |-
          BRANCH="main"

          # Create JSON objects for the branch protection fields
          STATUS_CHECKS_JSON=$(jq -n '{
            strict: true,
            contexts: ["Super Linter"]
          }')

          PR_REVIEWS_JSON=$(jq -n '{
            required_approving_review_count: 1,
            dismiss_stale_reviews: true
          }')

          RESTRICTIONS_JSON=$(jq -n '{}')  # Empty object for no user restrictions

          echo "Setting branch protection for branch: ${BRANCH}"
          gh api --method PUT \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/branches/${BRANCH}/protection" \
            -F required_status_checks="$STATUS_CHECKS_JSON" \
            -F enforce_admins=true \
            -F required_pull_request_reviews="$PR_REVIEWS_JSON" \
            -F restrictions="$RESTRICTIONS_JSON" \
            -F allow_force_pushes=false \
            -F allow_deletions=false \
            -F required_linear_history=true
